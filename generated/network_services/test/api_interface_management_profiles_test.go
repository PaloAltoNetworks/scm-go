/*
 * Network Services Testing
 *
 * InterfaceManagementProfilesAPIService
 */

package network_services

import (
	"context"
	"net/http"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"

	// Replace with your actual imports
	"github.com/paloaltonetworks/scm-go/common"
	"github.com/paloaltonetworks/scm-go/generated/network_services"
)

// --- Helper Functions for Setup ---

// generateProfileName creates a unique name for the resource.
func generateProfileName(base string) string {
	// Name must match: ^[a-zA-Z\d\-_.]+
	return base + common.GenerateRandomString(4)
}

// createBaseProfile creates a base InterfaceManagementProfiles object for testing.
func createBaseProfile(t *testing.T, baseName string) network_services.InterfaceManagementProfiles {
	name := generateProfileName(baseName)

	profile := *network_services.NewInterfaceManagementProfiles(name)

	// --- Contextual Fields (Set to Defaults for Comprehensive Tests) ---
	profile.SetFolder("All")

	// --- Service Flags (Set most to 'true' for a "full" profile) ---
	profile.SetHttp(true)
	profile.SetHttpOcsp(true)
	profile.SetHttps(true)
	profile.SetSsh(true)
	profile.SetPing(true)
	// Telnet is often discouraged, but setting it to 'true' or 'false' depends on what you want to test
	profile.SetTelnet(false)

	// --- User-ID Service Flags ---
	profile.SetUseridService(true)
	profile.SetUseridSyslogListenerSsl(true)
	profile.SetUseridSyslogListenerUdp(true)

	// --- Special Fields ---
	// ResponsePages is of type interface{} (can be null or a boolean/object), setting it explicitly.
	profile.SetResponsePages(false)

	// --- Permitted IP List (Set to a default list) ---
	defaultIPs := []network_services.InterfaceManagementProfilesPermittedIpInner{
		// Add a representative IP/CIDR entry
		*network_services.NewInterfaceManagementProfilesPermittedIpInner("198.18.0.1/32"),
		*network_services.NewInterfaceManagementProfilesPermittedIpInner("192.0.2.0/24"),
	}
	profile.SetPermittedIp(defaultIPs)

	// Note: 'Id' is generated by the server, so we do not set it here.

	return profile
}

// --- Test Cases for Profile Creation and Configuration ---

// Test_InterfaceManagementProfiles_CreateFullConfig tests creation with all services enabled
// and includes the permitted IP list structure.
func Test_InterfaceManagementProfiles_CreateFullConfig(t *testing.T) {
	client := SetupNetworkSvcTestClient(t)
	baseName := "profile-full-"
	intfProfile := createBaseProfile(t, baseName)

	// Explicitly enable all available services
	intfProfile.SetHttp(true)
	intfProfile.SetHttps(true)
	intfProfile.SetTelnet(false) // Telnet is generally disabled (as noted in the model comment)
	intfProfile.SetHttpOcsp(true)
	intfProfile.SetUseridService(true)
	intfProfile.SetUseridSyslogListenerSsl(true)
	intfProfile.SetUseridSyslogListenerUdp(true)

	// Add permitted IP list
	ipList := []network_services.InterfaceManagementProfilesPermittedIpInner{
		*network_services.NewInterfaceManagementProfilesPermittedIpInner("192.168.1.0/24"),
		*network_services.NewInterfaceManagementProfilesPermittedIpInner("10.10.10.1"),
	}
	intfProfile.SetPermittedIp(ipList)

	// --- Execution ---
	res, httpRes, err := client.InterfaceManagementProfilesAPI.
		CreateInterfaceManagementProfiles(context.Background()).
		InterfaceManagementProfiles(intfProfile).
		Execute()

	if err != nil {
		handleAPIError(err)
	}
	require.NoError(t, err, "Failed to create Interface Management Profile")
	assert.Equal(t, http.StatusCreated, httpRes.StatusCode, "Expected 201 Created status")
	createdID := res.GetId()

	// Cleanup
	defer func() {
		client.InterfaceManagementProfilesAPI.DeleteInterfaceManagementProfilesByID(context.Background(), createdID).Execute()
	}()

	// --- Assertions (Verify the configured state) ---

	// Name and required fields
	assert.Equal(t, intfProfile.GetName(), res.GetName(), "Profile name should match")

	// Boolean services assertions
	assert.True(t, res.GetHttp(), "HTTP should be enabled")
	assert.True(t, res.GetHttps(), "HTTPS should be enabled")
	assert.False(t, res.GetTelnet(), "Telnet should be disabled")
	assert.True(t, res.GetPing(), "Ping should be enabled")
	assert.True(t, res.GetUseridService(), "UseridService should be enabled")

	// Permitted IP list assertion
	require.True(t, res.HasPermittedIp(), "PermittedIp list must be set")
	assert.Len(t, res.GetPermittedIp(), 2, "Expected 2 IP entries")
	assert.Equal(t, "192.168.1.0/24", res.GetPermittedIp()[0].GetName(), "First IP should match")
}

// --- CRUD Tests (Using a simple profile as the standard setup) ---

// Test_InterfaceManagementProfiles_GetByID tests retrieving a Profile by ID.
func Test_InterfaceManagementProfiles_GetByID(t *testing.T) {
	client := SetupNetworkSvcTestClient(t)
	baseName := "profile-full-"

	// --- Setup: Create the full base object ---
	intfProfile := createBaseProfile(t, baseName)

	// Set some flags explicitly for clear assertion checks (though base helper already sets most)
	intfProfile.SetTelnet(true) // Ensure Telnet is enabled for this full test
	intfProfile.SetHttps(true)
	intfProfile.SetPing(true)

	// Set a distinct Permitted IP list
	ipList := []network_services.InterfaceManagementProfilesPermittedIpInner{
		*network_services.NewInterfaceManagementProfilesPermittedIpInner("192.168.1.0/24"),
		*network_services.NewInterfaceManagementProfilesPermittedIpInner("10.10.10.1"),
	}
	intfProfile.SetPermittedIp(ipList)

	// --- Execution ---
	res, httpRes, err := client.InterfaceManagementProfilesAPI.
		CreateInterfaceManagementProfiles(context.Background()).
		InterfaceManagementProfiles(intfProfile).
		Execute()

	t.Logf("  HTTP Response (httpRes): %+v", httpRes) // Prints the full HTTP response struct

	if err != nil {
		handleAPIError(err)
	}
	require.NoError(t, err, "Failed to create Interface Management Profile")
	assert.Equal(t, http.StatusCreated, httpRes.StatusCode, "Expected 201 Created status")
	createdID := res.GetId()

	// Cleanup
	defer func() {
		client.InterfaceManagementProfilesAPI.DeleteInterfaceManagementProfilesByID(context.Background(), createdID).Execute()
	}()

	// --- Assertions (Verify the created and returned object) ---

	// 1. Assert required fields and contextual fields
	assert.NotEmpty(t, createdID, "**ID must be generated**")
	assert.Equal(t, intfProfile.GetName(), res.GetName(), "**Profile name should match**")
	assert.Equal(t, intfProfile.GetFolder(), res.GetFolder(), "Folder should match input")

	// 2. Assert ALL service boolean flags
	assert.True(t, res.GetHttp(), "HTTP should be enabled")
	assert.True(t, res.GetHttpOcsp(), "HTTP OCSP should be enabled")
	assert.True(t, res.GetHttps(), "HTTPS should be enabled")
	assert.True(t, res.GetSsh(), "SSH should be enabled")
	assert.True(t, res.GetPing(), "Ping should be enabled")
	assert.True(t, res.GetTelnet(), "Telnet should not be enabled") // Based on this test's setup
	assert.False(t, res.GetResponsePages(), "Response Pages should not be enabled")
	assert.True(t, res.GetUseridService(), "User-ID Service should be enabled")
	assert.True(t, res.GetUseridSyslogListenerSsl(), "User-ID Syslog SSL should be enabled")
	assert.True(t, res.GetUseridSyslogListenerUdp(), "User-ID Syslog UDP should be enabled")

	// 4. Assert Permitted IP list structure and contents
	require.True(t, res.HasPermittedIp(), "**PermittedIp list must be set**")
	require.Len(t, res.GetPermittedIp(), 2, "**Expected 2 IP entries**")
	assert.Equal(t, "192.168.1.0/24", res.GetPermittedIp()[0].GetName(), "First IP should match input")
	assert.Equal(t, "10.10.10.1", res.GetPermittedIp()[1].GetName(), "Second IP should match input")
}

// Test_InterfaceManagementProfiles_Update tests updating an Interface Management Profile.
func Test_InterfaceManagementProfiles_Update(t *testing.T) {
	client := SetupNetworkSvcTestClient(t)
	intfProfile := createBaseProfile(t, "profile-update-")
	intfProfile.SetSsh(false)
	intfProfile.SetPing(false)
	// Initial IP list
	intfProfile.SetPermittedIp([]network_services.InterfaceManagementProfilesPermittedIpInner{
		*network_services.NewInterfaceManagementProfilesPermittedIpInner("10.0.0.1"),
	})

	// Setup: Create the initial profile
	createRes, _, err := client.InterfaceManagementProfilesAPI.CreateInterfaceManagementProfiles(context.Background()).InterfaceManagementProfiles(intfProfile).Execute()
	require.NoError(t, err, "Failed to create profile for update test setup")
	createdID := createRes.GetId()

	defer func() {
		client.InterfaceManagementProfilesAPI.DeleteInterfaceManagementProfilesByID(context.Background(), createdID).Execute()
	}()

	// Prepare updated object: Toggle services and change the IP list
	updatedIntf := *createRes
	updatedIntf.SetSsh(true)
	updatedIntf.SetPing(true)

	// Update IP list to a new value
	updatedIPList := []network_services.InterfaceManagementProfilesPermittedIpInner{
		*network_services.NewInterfaceManagementProfilesPermittedIpInner("203.0.113.1"),
		*network_services.NewInterfaceManagementProfilesPermittedIpInner("203.0.113.2"),
	}
	updatedIntf.SetPermittedIp(updatedIPList)

	// Test: Update the profile
	updateRes, httpResUpdate, errUpdate := client.InterfaceManagementProfilesAPI.
		UpdateInterfaceManagementProfilesByID(context.Background(), createdID).
		InterfaceManagementProfiles(updatedIntf).
		Execute()

	require.NoError(t, errUpdate, "Failed to update Interface Management Profile")
	assert.Equal(t, http.StatusOK, httpResUpdate.StatusCode, "Expected 200 OK status")

	// Verify the update
	assert.True(t, updateRes.GetSsh(), "SSH should be enabled after update")
	assert.True(t, updateRes.GetPing(), "Ping should be enabled after update")

	// Verify IP list replacement
	require.Len(t, updateRes.GetPermittedIp(), 2, "PermittedIp list must have 2 entries after update")
	assert.Equal(t, "203.0.113.1", updateRes.GetPermittedIp()[0].GetName(), "New IP must be set")
}

// Test_InterfaceManagementProfiles_DeleteByID tests deleting a Profile.
func Test_InterfaceManagementProfiles_DeleteByID(t *testing.T) {
	client := SetupNetworkSvcTestClient(t)
	intfProfile := createBaseProfile(t, "profile-delete-")
	intfProfile.SetSsh(true)

	// Setup: Create a profile first
	createRes, _, err := client.InterfaceManagementProfilesAPI.CreateInterfaceManagementProfiles(context.Background()).InterfaceManagementProfiles(intfProfile).Execute()
	require.NoError(t, err, "Failed to create profile for delete test setup")
	createdID := createRes.GetId()

	// Test: Delete the profile
	httpResDel, errDel := client.InterfaceManagementProfilesAPI.DeleteInterfaceManagementProfilesByID(context.Background(), createdID).Execute()

	require.NoError(t, errDel, "Failed to delete Interface Management Profile")
	assert.Equal(t, http.StatusOK, httpResDel.StatusCode, "Expected 200 OK status for deletion")
}

// Test_InterfaceManagementProfiles_List tests listing profiles.
func Test_InterfaceManagementProfiles_List(t *testing.T) {
	client := SetupNetworkSvcTestClient(t)
	folderName := "All"
	intfProfile := createBaseProfile(t, "profile-list-")
	intfProfile.SetFolder(folderName) // Use a specific folder for filtering
	intfProfile.SetSsh(true)

	// Setup: Create a profile first
	createRes, _, err := client.InterfaceManagementProfilesAPI.CreateInterfaceManagementProfiles(context.Background()).InterfaceManagementProfiles(intfProfile).Execute()
	require.NoError(t, err, "Failed to create profile for list test setup")
	createdID := createRes.GetId()

	defer func() {
		client.InterfaceManagementProfilesAPI.DeleteInterfaceManagementProfilesByID(context.Background(), createdID).Execute()
	}()

	// Test: List the profiles, filtering by folder
	listRes, httpResList, errList := client.InterfaceManagementProfilesAPI.ListInterfaceManagementProfiles(context.Background()).
		Folder(folderName).
		Limit(10).
		Execute()

	require.NoError(t, errList, "Failed to list Interface Management Profiles")
	assert.Equal(t, http.StatusOK, httpResList.StatusCode, "Expected 200 OK status")
	require.NotNil(t, listRes, "List response should not be nil")
	assert.GreaterOrEqual(t, len(listRes.Data), 1, "Expected at least one Interface Management Profile in the list")
}
